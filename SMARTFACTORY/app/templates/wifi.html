<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Settings</title>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Main CSS -->
    <link rel="stylesheet" href="/static/css/style.css" />
</head>

<body>
    <!-- HEADER -->
    <header class="app-header">
        <h2><i class="fas fa-wifi"></i> WiFi Settings</h2>
    </header>

    <!-- MAIN WRAPPER -->
    <div class="container">

        <!-- RIGHT PANEL: CURRENT STATUS -->
        <div class="section wifi-status-section">
            <h3><i class="fas fa-signal"></i> Current WiFi Status</h3>

            <div id="current-wifi" class="status-box">
                Loading...
            </div>

            <button onclick="loadCurrentWifi()" class="btn-primary">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>

        <!-- LEFT PANEL -->
        <div class="control-panel">
            <h3><i class="fas fa-search"></i> Nearby WiFi Networks</h3>

            <button onclick="scanWiFi()" class="btn-primary">
                <i class="fas fa-wifi"></i> Scan Now
            </button>

            <small style="font-size:12px; opacity:0.7;">Auto scan every 10s</small>

            <!-- TABLE LIST -->
            <div class="table-wrapper">
                <table class="wifi-table" id="wifi-table">
                    <thead>
                        <tr>
                            <th>SSID</th>
                            <th>Signal</th>
                            <th>Band</th>
                            <th>Channel</th>
                            <th>Security</th>
                        </tr>
                    </thead>
                    <tbody id="wifi-table-body">
                        <tr>
                            <td colspan="5" style="text-align:center; opacity:0.7;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <hr />

            <h3><i class="fas fa-link"></i> Connect to WiFi</h3>

            <div class="field">
                <span>SSID:</span>
                <input id="ssid-input" type="text" placeholder="Click a WiFi in the table" />
            </div>

            <div class="field" id="password-field">
                <span>Password:</span>
                <input id="password-input" type="password" placeholder="Password" />
            </div>

            <button id="btn-connect" onclick="connectWiFi()" class="btn-primary">
                <i class="fas fa-link"></i> Connect
            </button>

            <div id="wifi-status" style="margin-top:10px; font-weight:bold;"></div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script>
        let wifiData = [];
        let selectedRow = null;
        const AUTO_SCAN_INTERVAL = 10000;

        window.onload = () => {
            scanWiFi();
            loadCurrentWifi();
            setInterval(scanWiFi, AUTO_SCAN_INTERVAL);
            setInterval(loadCurrentWifi, AUTO_SCAN_INTERVAL);
        };

        // ======================================================
        // Format signal
        // ======================================================
        function formatSignal(signal) {
            if (!signal && signal !== 0)
                return `<span class="signal-weak">-</span>`;

            signal = parseInt(signal);

            if (signal >= 70) return `<span class="signal-strong">ðŸ“¶ ${signal}%</span>`;
            if (signal >= 40) return `<span class="signal-medium">ðŸ“¶ ${signal}%</span>`;

            return `<span class="signal-weak">ðŸ“¶ ${signal}%</span>`;
        }

        // ======================================================
        // Load WiFi list
        // ======================================================
        function scanWiFi() {
            fetch("/api/wifi/scan")
                .then(res => res.json())
                .then(d => {
                    wifiData = d.wifi_list || [];

                    let tbody = document.getElementById("wifi-table-body");
                    tbody.innerHTML = "";

                    wifiData.forEach((ap, index) => {
                        if (!ap.ssid || !ap.ssid.trim()) return;

                        // normalize security string
                        let sec = (ap.security || "").toString().trim().toLowerCase();
                        let isOpen = (sec === "" || sec === "unknown" || sec.includes("open"));

                        let securityLabel = isOpen ? "ðŸ”“ Open" : "ðŸ”’ " + (ap.security || "Secured");

                        let row = document.createElement("tr");
                        row.classList.add("wifi-row");

                        row.innerHTML = `
                            <td>${ap.ssid}</td>
                            <td>${formatSignal(ap.signal)}</td>
                            <td>${ap.band}</td>
                            <td>${ap.channel ?? "-"}</td>
                            <td>${securityLabel}</td>
                        `;

                        row.onclick = () => selectRow(index, row);
                        tbody.appendChild(row);
                    });
                });
        }

        // ======================================================
        // User clicks a WiFi row
        // ======================================================
        function selectRow(index, rowElement) {
            if (selectedRow)
                selectedRow.classList.remove("wifi-selected");

            rowElement.classList.add("wifi-selected");
            selectedRow = rowElement;

            const ap = wifiData[index];
            const sec = (ap.security || "").toLowerCase();

            document.getElementById("ssid-input").value = ap.ssid;

            // Show/hide password field
            let needPassword = !(sec.includes("open") || sec === "" || sec === "unknown");
            document.getElementById("password-field").style.display =
                needPassword ? "block" : "none";
        }

        // ======================================================
        // Connect WiFi
        // ======================================================
        function connectWiFi() {
            const ssid = document.getElementById("ssid-input").value.trim();
            const ap = wifiData.find(w => w.ssid === ssid);

            if (!ssid) {
                showStatus("âŒ SSID cannot be empty!", false);
                return;
            }

            if (!ap) {
                showStatus("âŒ WiFi not found in scan list!", false);
                return;
            }

            let isOpen = (ap.security || "").toLowerCase().includes("open");
            let password = document.getElementById("password-input").value.trim();

            if (!isOpen && !password) {
                showStatus("âŒ Password required!", false);
                return;
            }

            fetch("/api/wifi/connect", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    ssid,
                    password,
                    secure: !isOpen
                })
            })
                .then(res => res.json())
                .then(d => {
                    showStatus(d.success ? "Connected!" : d.message, d.success);
                });
        }

        function showStatus(msg, ok) {
            const status = document.getElementById("wifi-status");
            status.innerText = msg;
            status.style.color = ok ? "green" : "red";
        }

        // ======================================================
        // Load current connected WiFi info
        // ======================================================
        function loadCurrentWifi() {
            fetch("/api/wifi/status")
                .then(res => res.json())
                .then(info => {
                    document.getElementById("current-wifi").innerHTML = `
                        <b>SSID:</b> ${info.ssid || "N/A"}<br>
                        <b>Signal:</b> ${info.signal || "-"}<br>
                        <b>BSSID:</b> ${info.bssid || "-"}<br>
                        <b>Channel:</b> ${info.channel || "-"}<br>
                        <b>Freq:</b> ${info.freq ? info.freq + " MHz" : "-"}<br>
                        <b>Band:</b> ${info.band || "-"}<br>
                        <b>Security:</b> ${info.security || "-"}<br>
                        <b>Device:</b> ${info.device || "-"}
                    `;
                });
        }
    </script>

</body>

</html>